##### æ€è·¯

æœ¬é¢˜éš¾ç‚¹åœ¨äºå¦‚ä½•å¤„ç†``Chargebacks`è¡¨ï¼Œé¢˜ç›®ä¸­è¯´ï¼š**æ¯é¡¹é€€å•éƒ½å¯¹åº”äºä¹‹å‰è¿›è¡Œçš„äº¤æ˜“ï¼Œå³ä½¿æœªç»æ‰¹å‡†ã€‚**è¿™è¯´æ˜æˆ‘ä»¬åº”è¯¥ä½¿ç”¨`full outer join` æ„é€ chargebackè¿™ä¸ªstateï¼Œç„¶åå†å¯¹å¹´æœˆgroup byè®¡ç®—å„ç±»æŒ‡æ ‡ã€‚

> âš ï¸ MySQLæ²¡æœ‰full outer joinï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆleft joinå†union allã€‚

##### ç®—æ³•

1. union all

* sql

```sql
with cte as
(
    select * from transactions
    union all
    select id, country, 'chargeback' state, amount, c.trans_date
    from chargebacks c left join transactions t 
    on c.trans_id = t.id
) 
# å…¶å®æ˜¯full outer join
```

2. è®¡ç®—æŒ‡æ ‡

* sql

```sql
select 
    date_format(trans_date, '%Y-%m') month,  # è½¬æ¢å¹´æœˆ
    country,
    sum(state = 'approved') approved_count,
    sum(if(state = 'approved', amount, 0)) approved_amount,
    sum(state = 'chargeback') chargeback_count,
    sum(if(state = 'chargeback', amount, 0)) chargeback_amount
from cte 
group by month, country
having approved_count <> 0 or chargeback_amount <> 0
# æ³¨æ„ï¼šåœ¨æ‚¨çš„æŸ¥è¯¢ä¸­ï¼Œåªéœ€æ˜¾ç¤ºç»™å®šæœˆä»½å’Œå›½å®¶ï¼Œå¿½ç•¥æ‰€æœ‰ä¸ºé›¶çš„è¡Œã€‚
```

##### ç­”æ¡ˆ

* sql

```sql
with cte as
(
    select * from transactions
    union all
    select id, country, 'chargeback' state, amount, c.trans_date
    from chargebacks c left join transactions t 
    on c.trans_id = t.id
) 

select 
    date_format(trans_date, '%Y-%m') month, 
    country,
    sum(state = 'approved') approved_count,
    sum(if(state = 'approved', amount, 0)) approved_amount,
    sum(state = 'chargeback') chargeback_count,
    sum(if(state = 'chargeback', amount, 0)) chargeback_amount
from cte 
group by month, country
having approved_amount or chargeback_amount
```

ğŸ¥°è§‰å¾—è¿˜ä¸é”™çš„è¯ï¼Œç‚¹ä¸ªèµï¼ŒåŠ ä¸ªå…³æ³¨å§~ğŸ¥°
